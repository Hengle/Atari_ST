* Saver V1: transforme BMP ==> ST
* V1 = sauvegarde d'un seul plan, 320*200 ( 8000 octets )

	CLR.L	-(SP)
	MOVE	#$20,-(SP)
	TRAP	#1
	ADDQ	#6,SP
	
	CLR	-(SP)
	PEA	-1.W
	PEA	-1.W
	MOVE	#5,-(SP)
	TRAP	#14
	LEA	12(SP),SP
	
	LEA	IMG+54,A0	D‚but palette
	LEA	PALETTE,A1
	MOVE	#16-1,D7
CREE_PALETTE	MOVEQ	#0,D4
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVE	#%11100000,D4
	MOVE.B	(A0)+,D0	R
	MOVE.B	(A0)+,D1	V
	MOVE.B	(A0)+,D2	B
	MOVE.B	(A0)+,D3	INUTILISEE
	AND.B	D4,D0	ON VIRE TOUT...
	AND.B	D4,D1
	AND.B	D4,D2
	LSR.B	#5,D0
	LSR.B	#5,D2
	LSR.B	#1,D1
	MOVEQ	#0,D3
	OR.B	D0,D3
	OR.B	D1,D3
	MOVE.B	D2,(A1)+
	MOVE.B	D3,(A1)+
	DBF	D7,CREE_PALETTE
FINI1	NOP

	;MOVEM.L	PALETTE,D0-D7
	;MOVEM.L	D0-D7,$FFFF8240.W

	LEA	IMG+1082-4,A0	DEBUT IMAGE? ESSAI...
	LEA	TABLE_RT,A1
	MOVEQ	#0,D5
	;MOVE.L	$44E.W,A4
	LEA	BUFFER,A4
	MOVE.L	A4,A3
	ADDA.L	#320*480-320,A3
	;LEA	32000-160(A3),A3
	LEA	-320(A4),A4
	MOVE	#%1000000000000000,D1
GO	MOVEQ	#0,D0
	MOVE.B	(A0),D0
	TST	FLAG_POURRI
	BEQ.S	KOKO
	CLR	FLAG_POURRI
	ADDQ	#1,A0
	AND.B	#%00001111,D0
	JMP	Y
KOKO	MOVE	#1,FLAG_POURRI
	AND.B	#%11110000,D0
	LSR.B	#4,D0
Y	TST.B	D0
	BLT.S	Z
	CMPI.B	#15,D0
	BLE.S	OK
	MOVE	#$700,$FFFF8240.W
JU	BRA.S	JU
OK	ADD	D0,D0
	ADD	D0,D0
	LEA	(A1,D0.W),A2
	MOVE.L	(A2),A2
	JSR	(A2)
Z	LSR	#1,D1
	BNE.S	GO
	MOVE	#%1000000000000000,D1
	ADDQ	#8,A3

	ADDQ	#8,D5
	CMPI	#320,D5
	BNE.S	ROOL
	MOVEQ	#0,D5
	LEA	-320*2(A3),A3
	;LEA	320(A0),A0
ROOL	
	CMP.L	A4,A3
	BNE.S	GO

	MOVE	#$001,$FFFF8240.W
GOGO2
	LEA	BUFFER,A1
	LEA	BUF,A4
	MOVE	#480-1,D1
.G	
	MOVE.L	A1,A3
	MOVE	#28-1,D0
.H	MOVE	2(A1),(A4)+
	ADDQ	#8,A1
	DBF	D0,.H
	LEA	320(A3),A1
	DBF	D1,.G
***
GOGO	JSR	EFF
	MOVE.L	$44E.W,A0
	LEA	BUF,A1
	ADDA.L	CNT,A1
	MOVE	#200-1,D1
.J	MOVE	#20-1,D0
.K	MOVE	(A1)+,(A0)
	ADDQ	#8,A0
	DBF	D0,.K
	LEA	8*2(A1),A1
	;LEA	160(A),A1
	DBF	D1,.J

FINI2	CMPI.B	#$3B,$FFFFFC02.W
	BNE.S	.PA_F1
	ADD.L	#28*2,CNT
	JMP	GOGO
.PA_F1	CMPI.B	#$3C,$FFFFFC02.W
	BNE.S	.PA_F2
	SUB.L	#28*2,CNT
	JMP	GOGO
.PA_F2
	CMPI.B	#$3D,$FFFFFC02.W
	BNE.S	.PA_F3
	ADD.L	#2,CNT
	JMP	GOGO	
.PA_F3
	CMPI.B	#$3E,$FFFFFC02.W
	BNE.S	.PA_F4
	SUB.L	#2,CNT
	JMP	GOGO
.PA_F4
	CMPI.B	#1,$FFFFFC02.W
	BEQ.S	.SAV
	BRA	FINI2
.SAV
	CLR	-(SP)
	PEA	NAME
	MOVE	#$3C,-(SP)
	TRAP	#1
	ADDQ	#8,SP
	TST	D0
	BMI	ERROR
	
	MOVE	#2,-(SP)
	PEA	NAME
	MOVE	#$3D,-(SP)
	TRAP	#1
	ADDQ	#8,SP
	TST	D0
	BMI	ERROR
	MOVE	D0,HANDLE

	MOVE.L	$44E.W,A0
	LEA	BUFF,A1
	MOVE	#3999,D1
CO	MOVE	(A0),(A1)+
	ADDQ	#8,A0
	DBF	D1,CO

	PEA	BUFF
	MOVE.L	#8000,-(SP)
	MOVE	D0,-(SP)
	MOVE	#40,-(SP)
	TRAP	#1
	LEA	12(SP),SP

HANDLE	EQU	*+2
	MOVE	#2,-(SP)
	MOVE	#$3E,-(SP)
	TRAP	#1
	ADDQ	#4,SP
	TST	D0
	BMI	ERROR
	
	MOVE	#$070,$FFFF8240.W
OKY	BRA.S	OKY
ERROR	MOVE	#$700,$FFFF8240.W
OKYU	BRA.S	OKYU

NAME	DC.B	'A:\ZAP1.GFX',0

EFF	MOVE.L	$44E.W,A1
	MOVE	#7999,D0
.J	CLR.L	(A1)+
	DBF	D0,.J
	RTS
CNT	DC.L	0

FLAG_POURRI	DC	0

RT_0	OR	D1,(A3)	0001
RT_00	RTS
RT_1	OR	D1,2(A3)	0010
	RTS
RT_2	OR	D1,(A3)	0011
	OR	D1,2(A3)
	RTS
RT_3	OR	D1,4(A3)	0100
	RTS
RT_4	OR	D1,4(A3)	0101
	OR	D1,(A3)
	RTS
RT_5	OR	D1,4(A3)	0110
	OR	D1,2(A3)
	RTS
RT_6	OR	D1,4(A3)	0111
	OR	D1,2(A3)
	OR	D1,(A3)
	RTS
RT_7	OR	D1,6(A3)	1000
	RTS
RT_8	OR	D1,6(A3)	1001
	OR	D1,(A3)
	RTS
RT_9	OR	D1,6(A3)	1010
	OR	D1,2(A3)
	RTS
RT_10	OR	D1,6(A3)	1011
	OR	D1,2(A3)
	OR	D1,(A3)
	RTS
RT_11	OR	D1,6(A3)	1100
	OR	D1,4(A3)
	RTS
RT_12	OR	D1,6(A3)	1101
	OR	D1,4(A3)
	OR	D1,(A3)
	RTS
RT_13	OR	D1,6(A3)	1110
	OR	D1,4(A3)
	OR	D1,2(A3)
	RTS
RT_14	OR	D1,6(A3)	1111
	OR	D1,4(A3)
	OR	D1,2(A3)
	OR	D1,(A3)
	RTS

IMG	INCBIN	ZAP31.BMP

	DC.L	RT_00

TABLE_RT	
	DC.L	RT_0
	DC.L	RT_0
	DC.L	RT_1
	DC.L	RT_2
	DC.L	RT_3
	DC.L	RT_4
	DC.L	RT_5
	DC.L	RT_6
	DC.L	RT_7
	DC.L	RT_8
	DC.L	RT_9
	DC.L	RT_10
	DC.L	RT_11
	DC.L	RT_12
	DC.L	RT_13
	DC.L	RT_14
	;DC.L	RT_14


FIN:	MOVE.L	4.W,A0
	JMP	(A0)

 	SECTION BSS

;F_PILE	DS.L 	128	
;D_PILE	DS.L 	1	
BUF	DS.B	26880
PALETTE	DS.W	16
	DS.B	256
BUFFER	DS.B	320*480
BUFF	DS.B	8000