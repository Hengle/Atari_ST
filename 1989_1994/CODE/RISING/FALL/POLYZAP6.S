;OPT: VIRER LES NOT => CHANGER DE TABLE. MAIS MANQUE 2 REGISTRES
NB_PASSES = 200

TST=160
	CLR.L	-(SP)
	MOVE	#$20,-(SP)
	TRAP	#1
	ADDQ.L	#6,SP
	
	CLR	-(SP)
	PEA	-1.W
	PEA	-1.W
	MOVE	#5,-(SP)
	TRAP	#14
	LEA	12(SP),SP	

	MOVE.L	#FIN,$008.W
	MOVE.L	#FIN,$00C.W
	MOVE.L	#FIN,$010.W
	MOVE.L	#FIN,$014.W

*DEPART: 2 TABLEAUX : Xs DE LA VBL PRECEDENTE
*	       Xs DE LA VBL EN COURS

	JSR	INIT

	LEA	TABLE,A0
	LEA	TABLE_EFF,A1
	MOVE	#19,D0
ICOP	MOVE.L	(A1)+,-(A0)
	DBF	D0,ICOP

	MOVE.L	#TABLO1,TAB1
	MOVE.L	#TABLO2,TAB2
	MOVE.L	#TST,D0	DEPART
	MOVE.L	#TST,D1	ARRIVEE
	MOVE.L	TAB2,A0
	JSR	DO_TRANS

	MOVE.L	#VBL,$70.W
K	JMP	K
DO_TRANS
	MOVE.L	#NB_PASSES,D2	EN 'D2' PASSES
	MOVE.L	D2,D6
	MOVE	D2,MODIF
	MOVE	D2,MODIF_

	LSL.L	#8,D0
	LSL.L	#8,D1
	CMP.L	D0,D1
	BGT.S	ROUTY1
ROUTY2	;D1 PLUS PETIT
	MOVE.L	D0,D2
	SUB.L	D1,D0	D1=AMPLITUDE
	DIVU	D6,D0
	SWAP	D0
	CLR	D0
	SWAP	D0
MODIF_	EQU	*+2
	MOVE	#0,D7
	SUBQ	#1,D7
DO_IT_AGAIN_	SUB.L	D0,D2
	MOVE.L	D2,D3
	LSR.L	#8,D3	CA EN FAIT UN
	MOVE	D3,(A0)
	BGE.S	GOONN
	CLR	(A0)
GOONN	CMPI	#319,(A0)
	BLE.S	GOI
	MOVE	#319,(A0)
	
GOI	ADDQ.L	#4,A0
	DBF	D7,DO_IT_AGAIN_
FINI2	RTS
****
	
ROUTY1	;D0 PLUS PETIT
	MOVE.L	D0,D2
	SUB.L	D0,D1	D1=AMPLITUDE
	DIVU	D6,D1
	SWAP	D1
	CLR	D1
	SWAP	D1
MODIF	EQU	*+2
	MOVE	#0,D7
	SUBQ	#1,D7
DO_IT_AGAIN	ADD.L	D1,D2
	MOVE.L	D2,D3
	LSR.L	#8,D3	CA EN FAIT UN
	MOVE	D3,(A0)
	BGE.S	GOON
	CLR	(A0)
GOON	
	CMPI	#319,(A0)
	BLE.S	KK
	MOVE	#319,(A0)
KK	ADDQ.L	#4,A0
	DBF	D7,DO_IT_AGAIN
FINITED	RTS

*********************************************************************
VBL	SF	$FFFF8240.W


	MOVE.L	$44E.W,A6
	LEA	-160(A6),A6
	MOVE.L	TAB1,A5
	MOVE.L	TAB2,A1
	LEA	TABLE1,A2
	LEA	TABLE2,A3

	MOVE	#200-1,D3

BOUCLE	
	LEA	160(A6),A6	2=3.125
	MOVE.L	A6,A0	1=1.5625

	MOVE	(A5)+,D6	X1|2=3.125
	MOVE	(A1)+,D4	X3|2=3.125

	MOVE	D4,D7	1=1.5625
	SUB	D6,D4	X1-X3|1=1.5625
	BGT	EFF	X1 < X3|3=4.6875
	BLT.S	AFF	X1 > X3|2=3.125

SUITE	;TOTAL=     
	MOVE.L	A6,A0	1

	MOVE	(A5)+,D6	X2|
	MOVE	(A1)+,D4	X4|

	MOVE	D4,D7
	SUB	D6,D4	X2-X4
	BGT	AFF2	X2 < X4
	BLT.S	EFF2	X2 > X4
SUITE2

	DBF	D3,BOUCLE	4.6875 LIGNES DE DBF
FINI;	TOTAL A VIDE=48.4375 LIGNES => INADMISSIBLE!!
	BRA.S	FIN_VBL

AFF	JSR	AFFICHE
	BRA.S	SUITE
EFF	
	;EXG.L	D6,D7
	;JSR	EFFACE
	JSR	AFFICHE
	BRA.S	SUITE
AFF2	
	EXG.L	D6,D7
	JSR	AFFICHE
	BRA.S	SUITE2
EFF2	
	JSR	EFFACE
	BRA.S	SUITE2

FIN_VBL

;	CMPI.B	#$F,$FFFFFC02.W
;	BNE.S	KS
;	ST	$FFFF8240.W
	MOVE	#$002,$FFFF8240.W	
KS
	MOVE.L	TAB1,D0
	MOVE.L	TAB2,TAB1
	MOVE.L	D0,TAB2


MODX	EQU	*+2
	MOVE.L	#TST,D0	DEPART
MODX2	EQU	*+2
	MOVE.L	#TST,D1	ARRIVEE
	MOVE.L	TAB2,A0
	JSR	DO_TRANS
	MOVE	#$004,$FFFF8240.W
	CMPI.B	#$3B,$FFFFFC02.W
	BNE.S	PASTOUCH
	SUB.L	#3,MODX
	SUB.L	#1,MODX2
PASTOUCH	
	CMPI.B	#$3C,$FFFFFC02.W
	BNE.S	PASTOUCH2
	ADD.L	#3,MODX
	ADD.L	#1,MODX2
PASTOUCH2

	RTE
;FLG	DC	0
TAB1	DC.L	0
TAB2	DC.L	0
FIN	MOVE.L	4.W,A0
	JMP	(A0)
AFFICHE	LEA	TABLE,A4
	MOVE.L	#$FFFFFFFF,D1

	MOVE	D6,D4
	MOVE	D7,D5

	LSR	#4,D6	D7=>DETERMINE ROUT A APPELER
	LSR	#4,D7	D7=>DETERMINE ROUT A APPELER
	SUB	D7,D6	DELTA X
	LSL	#2,D6

	ADD	D5,D5	x3*4 ( x3<x1 )
	ADD	D5,D5
	MOVE	(A2,D5.W),D0	motif
	ADD	2(A2,D5.W),A0
	ADD	D4,D4	x1*4 ( ancien x )
	ADD	D4,D4
	MOVE	(A3,D4.W),D2	motif

	MOVE.L	(A4,D6.W),A4
	JSR	(A4)
	RTS
***************
EFFACE	MOVE	#$007,$FFFF8240.W
	LEA	TABLE_EFF,A4
	moveq	#0,d1
;	MOVE	#1,D6
	MOVE	D6,D4
;	MOVE	#319,D7
	MOVE	D7,D5


	LSR	#4,D6	D7=>DETERMINE ROUT A APPELER
	LSR	#4,D7	D7=>DETERMINE ROUT A APPELER
	SUB	D7,D6	DELTA X
	LSL	#2,D6

;	SUBQ	#1,D5
	ADD	D5,D5	x3*4 ( x3<x1 )
	ADD	D5,D5
	MOVE	(A2,D5.W),D0	motif
	ADD	2(A2,D5.W),A0
;	SUBQ	#1,D4
	ADD	D4,D4	x1*4 ( ancien x )
	ADD	D4,D4
	MOVE	(A3,D4.W),D2	motif

	MOVE.L	(A4,D6.W),A4
	JSR	(A4)
	RTS
**********
TABLO1	
	REPT	200
	DC	160,319
	ENDR
TABLO2	REPT	200
	DC	0,319
	ENDR
**********************
INIT	
	LEA	CODE,A0
	LEA	TABLE,A1

	MOVE.L	A0,(A1)+
	MOVE.L	#8,D0
	MOVE	#$C440,(A0)+
	MOVE	#$8550,(A0)+
	MOVE	#$4E75,(A0)+
	MOVE.L	A0,(A1)+
	MOVE.L	#8,D0
	MOVE	#$8150,(A0)+
	MOVE	#$8568,(A0)+
	MOVE	D0,(A0)+
	MOVE	#$4E75,(A0)+

	MOVE	#17,D7
	MOVE	#-1,D6
DOCODE	
	MOVE.L	A0,(A1)+

	MOVE.L	#8,D0
	ADDQ	#1,D6
	MOVE	D6,D1
	MOVE	#$8150,(A0)+
DOMOVE	MOVE	#$3141,(A0)+
	MOVE	D0,(A0)+
	ADDQ	#8,D0
	DBF	D1,DOMOVE
	MOVE	#$8568,(A0)+
	MOVE	D0,(A0)+
	MOVE	#$4E75,(A0)+
	DBF	D7,DOCODE
************
	LEA	CODE2,A0
	LEA	TABLE_EFF,A1

	MOVE.L	A0,(A1)+
	MOVE.L	#8,D0
	MOVE	#$C440,(A0)+
	MOVE.L	#$46404642,(A0)+
	MOVE	#$C550,(A0)+
	MOVE	#$4E75,(A0)+
	MOVE.L	A0,(A1)+
	MOVE.L	#8,D0
	MOVE.L	#$46404642,(A0)+
	MOVE	#$C150,(A0)+
	MOVE	#$C568,(A0)+
	MOVE	D0,(A0)+
	MOVE	#$4E75,(A0)+

	MOVE	#17,D7
	MOVE	#-1,D6
DOCODE2
	MOVE.L	A0,(A1)+

	MOVE.L	#8,D0
	ADDQ	#1,D6
	MOVE	D6,D1
	MOVE.L	#$46404642,(A0)+
	MOVE	#$C150,(A0)+
DOMOVE2	MOVE	#$3141,(A0)+
	MOVE	D0,(A0)+
	ADDQ	#8,D0
	DBF	D1,DOMOVE2
	MOVE	#$C568,(A0)+
	MOVE	D0,(A0)+
	MOVE	#$4E75,(A0)+
	DBF	D7,DOCODE2

	RTS

	DATA

N	SET	152
	REPT	20
	DC	%0000000000000001,N
	DC	%0000000000000011,N
	DC	%0000000000000111,N
	DC	%0000000000001111,N
	DC	%0000000000011111,N
	DC	%0000000000111111,N
	DC	%0000000001111111,N
	DC	%0000000011111111,N
	DC	%0000000111111111,N
	DC	%0000001111111111,N
	DC	%0000011111111111,N
	DC	%0000111111111111,N
	DC	%0001111111111111,N
	DC	%0011111111111111,N
	DC	%0111111111111111,N
	DC	%1111111111111111,N
N	SET	N-8
	ENDR

TABLE1
N	SET	0
	REPT	20
	DC	%1111111111111111,N
	DC	%0111111111111111,N
	DC	%0011111111111111,N
	DC	%0001111111111111,N
	DC	%0000111111111111,N
	DC	%0000011111111111,N
	DC	%0000001111111111,N
	DC	%0000000111111111,N
	DC	%0000000011111111,N
	DC	%0000000001111111,N
	DC	%0000000000111111,N
	DC	%0000000000011111,N
	DC	%0000000000001111,N
	DC	%0000000000000111,N
	DC	%0000000000000011,N
	DC	%0000000000000001,N
N	SET	N+8
	ENDR


N	SET	152
	REPT	20
	DC	%1111111111111111,N
	DC	%1111111111111110,N
	DC	%1111111111111100,N
	DC	%1111111111111000,N
	DC	%1111111111110000,N
	DC	%1111111111100000,N
	DC	%1111111111000000,N
	DC	%1111111110000000,N
	DC	%1111111100000000,N
	DC	%1111111000000000,N
	DC	%1111110000000000,N
	DC	%1111100000000000,N
	DC	%1111000000000000,N
	DC	%1110000000000000,N
	DC	%1100000000000000,N
	DC	%1000000000000000,N
N	SET	N-8
	ENDR
TABLE2
N	SET	0
	REPT	20
	DC	%1000000000000000,N
	DC	%1100000000000000,N
	DC	%1110000000000000,N
	DC	%1111000000000000,N
	DC	%1111100000000000,N
	DC	%1111110000000000,N
	DC	%1111111000000000,N
	DC	%1111111100000000,N
	DC	%1111111110000000,N
	DC	%1111111111000000,N
	DC	%1111111111100000,N
	DC	%1111111111110000,N
	DC	%1111111111111000,N
	DC	%1111111111111100,N
	DC	%1111111111111110,N
	DC	%1111111111111111,N
N	SET	N+8
	ENDR


	BSS
	DS.L	20
TABLE	DS.L	20
TABLE_EFF	DS.L	20
CODE	DS.B	900
CODE2	DS.B	1000
