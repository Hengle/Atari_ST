NB_PASSES = 10
NB_SEG = 4
DEBUT:
	LEA.L 	D_PILE,A7
	
	PEA	0.W
	MOVE 	#$20,-(SP)
	TRAP 	#1
	ADDQ.L 	#6,SP

	CLR.W 	-(SP)
	PEA	-1.W
	PEA	-1.W
	MOVE 	#5,-(SP)
	TRAP 	#14
	LEA.L 	12(SP),SP

	MOVE.L	#FIN,$008.W
	MOVE.L	#FIN,$00C.W
	MOVE.L	#FIN,$010.W
	MOVE.L	#FIN,$014.W
	JSR	LINE
	move.l	#BUFFER,d0
	CLR.B	D0
	move.l	d0,SCREEN1
	add.l	#32000,d0
	move.l	d0,SCREEN2
	MOVEM.L	IMG+2,D0-D7
	MOVEM.L	D0-D7,$FFFF8240.W
	MOVE.L	SCREEN1,A0
	MOVE.L	SCREEN2,A1
	LEA	IMG+34,A2
	MOVE	#7999,D0
COP	MOVE.L	(A2),(A0)+
	MOVE.L	(A2)+,(A1)+
	DBF	D0,COP
	move.l	SCREEN1,d0
	lsr.l	#8,d0
	move.l	#$ffff8201,a0
	movep	d0,(a0)

;	MOVE	#7,-(SP)
;	TRAP	#1
;	ADDQ	#2,SP
	
	LEA	FORME_DEP,A4
	LEA	FORME_FIN,A5

	MOVE	#NB_SEG-1,D4	NB_LIGNES
DO_A_LINE	MOVEQ	#3,D5
DO_A_COORD	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE	(A4)+,D0
	MOVE	(A5)+,D1
	LEA	COORD,A0
MOD_R	EQU	*+2
	LEA	0(A0),A0
MOD_T	EQU	*+2
	LEA	0(A0),A0
	JSR	DO_TRANS
	ADD	#2,MOD_T
	DBF	D5,DO_A_COORD
	CLR	MOD_T
	ADD	#NB_PASSES*8,MOD_R
	DBF	D4,DO_A_LINE

;	MOVE.L	#5,D0	DEPART
;	MOVE.L	#315,D1	ARRIVEE
;	LEA	COORD,A0
;	JSR	DO_TRANS
;	MOVE.L	#15,D0	DEPART
;	MOVE.L	#5,D1	ARRIVEE
;	LEA	COORD,A0
;	ADDQ.L	#2,A0
;	JSR	DO_TRANS
;	MOVE.L	#7,D0	DEPART
;	MOVE.L	#300,D1	ARRIVEE
;	LEA	COORD,A0
;	ADDQ.L	#4,A0
;	JSR	DO_TRANS
;	MOVE.L	#195,D0	DEPART
;	MOVE.L	#185,D1	ARRIVEE
;	LEA	COORD,A0
;	ADDQ.L	#6,A0
;	JSR	DO_TRANS

;	LEA	COORD,A0
;	LEA	4*NB_PASSES*2(A0),A0
;	MOVE.L	#$99999999,(A0)

	MOVE.L	#INTER_RTE,$68.W
	CLR.B	$FFFFFA07.W
	CLR.B	$FFFFFA09.W
	
	CLR.B	$FFFFFA1B.W
	BSET	#0,$FFFFFA07.W
	BSET	#0,$FFFFFA13.W

	MOVE.L	#VBL_DEP,$70.W

BOUCLE	BRA.S	BOUCLE
FIN	MOVE.L	4.W,A0
	JMP	(A0)

VBL
	CLR.B	$FFFFFA1B.W
;	MOVE.B	#1,$FFFFFA21.W
;	MOVE.B	#8,$FFFFFA1B.W

	;MOVE	#$666,$FFFF8242.W

	CMPI.B	#$F,$FFFFFC02.W
	BNE.S	efecr
	ST	$FFFF8240.W
efecr	
	JSR	EFF

	LEA	COORD,A0
	ADDA.L	PNT,A0
	MOVE	#NB_SEG-1,D7
BOUCLED	MOVE	(A0),D0
	MOVE	2(A0),D1
	MOVE	4(A0),D2
	MOVE	6(A0),D3
	MOVEM.L	A0/D7,-(SP)
	MOVE.L	SCREEN1,A0
	ADDQ	#4,A0
	jsr	LINE+78
	MOVEM.L	(SP)+,A0/D7
	LEA	8*NB_PASSES(A0),A0
	DBF	D7,BOUCLED
	ADDQ.L	#4*2,PNT
	CMPI.L	#4*2*NB_PASSES,PNT
	BNE.S	OKOK
	CLR.L	PNT
	MOVE.L	#VBL_FIN,$70.W
OKOK	move.l	SCREEN1,d0
	MOVE.L	SCREEN2,SCREEN1
	MOVE.L	D0,SCREEN2
	lsr.l	#8,d0
	move.l	#$ffff8201,a0
	movep	d0,(a0)

	SF	$FFFF8240.W

;	CMPI.B	#$39,$FFFFFC02.W
;	BEQ	FIN
INTER_RTE	RTE
VBL_DEP
	CLR.B	$FFFFFA1B.W
	;MOVE	#$666,$FFFF8242.W
	CMPI.B	#$F,$FFFFFC02.W
	BNE.S	U
	ST	$FFFF8240.W
U
	JSR	EFF

	LEA	FORME_DEP,A0
	MOVE	#NB_SEG-1,D7
BOUCLED1	MOVE	(A0),D0
	MOVE	2(A0),D1
	MOVE	4(A0),D2
	MOVE	6(A0),D3
	MOVEM.L	A0/D7,-(SP)
	MOVE.L	SCREEN1,A0
	ADDQ	#4,A0
	jsr	LINE+78
	MOVEM.L	(SP)+,A0/D7
	ADDQ.L	#8,A0
	DBF	D7,BOUCLED1

	move.l	SCREEN1,d0
	MOVE.L	SCREEN2,SCREEN1
	MOVE.L	D0,SCREEN2
	lsr.l	#8,d0
	move.l	#$ffff8201,a0
	movep	d0,(a0)

	SF	$FFFF8240.W
	ADDQ.L	#1,TIME
	CMPI.L	#50,TIME
	BNE.S	NOT_SO_SOON
	CLR.L	TIME
	MOVE.L	#VBL,$70.W
NOT_SO_SOON	RTE
VBL_FIN
	CLR.B	$FFFFFA1B.W
	;MOVE	#$666,$FFFF8242.W
	CMPI.B	#$F,$FFFFFC02.W
	BNE.S	U2
	ST	$FFFF8240.W
U2
	JSR	EFF

	LEA	FORME_FIN,A0
	MOVE	#NB_SEG-1,D7
BOUCLED3	MOVE	(A0),D0
	MOVE	2(A0),D1
	MOVE	4(A0),D2
	MOVE	6(A0),D3
	MOVEM.L	A0/D7,-(SP)
	MOVE.L	SCREEN1,A0
	ADDQ	#4,A0
	jsr	LINE+78
	MOVEM.L	(SP)+,A0/D7
	ADDQ.L	#8,A0
	DBF	D7,BOUCLED3

	move.l	SCREEN1,d0
	MOVE.L	SCREEN2,SCREEN1
	MOVE.L	D0,SCREEN2
	lsr.l	#8,d0
	move.l	#$ffff8201,a0
	movep	d0,(a0)

	SF	$FFFF8240.W
	ADDQ.L	#1,TIME
	CMPI.L	#50,TIME
	BNE.S	NOT_SO_SOON2
	CLR.L	TIME
	MOVE.L	#VBL_DEP,$70.W
NOT_SO_SOON2	RTE

TIME	DC.L	0
EFF	movea.l	SCREEN1,a0
	LEA	160*150(A0),A0
	moveq	#0,d0
	moveq	#0,d1
	moveq	#0,d2
	moveq	#0,d3
	moveq	#0,d4
	moveq	#0,d5
	moveq	#0,d6
	moveq	#0,d7
	sub.l	a1,a1
	sub.l	a2,a2
	sub.l	a3,a3
	sub.l	a4,a4
	sub.l	a5,a5
	sub.l	a6,a6
efecr1	
	MOVE	#49,D1
CLS
N	SET	0
	REPT	20
	MOVE	D0,N+4(A0)
N	SET	N+8
	ENDR
	LEA	160(A0),A0
	DBF	D1,CLS

	RTS
;	MOVE.L	#0,D0	DEPART
;	MOVE.L	#319,D1	ARRIVEE
;	LEA	COORD,A0
DO_TRANS
	MOVE.L	#NB_PASSES,D2	EN 'D2' PASSES
	MOVE.L	D2,D6
	MOVE	D2,MODIF
	MOVE	D2,MODIF_

	LSL.L	#8,D0
	LSL.L	#8,D1
	CMP.L	D0,D1
	BGT.S	ROUTY1
ROUTY2	;D1 PLUS PETIT
	MOVE.L	D0,D2
	SUB.L	D1,D0	D1=AMPLITUDE
	DIVU	D6,D0
	SWAP	D0
	CLR	D0
	SWAP	D0
MODIF_	EQU	*+2
	MOVE	#0,D7
	SUBQ	#1,D7
DO_IT_AGAIN_	SUB.L	D0,D2
	MOVE.L	D2,D3
	LSR.L	#8,D3	CA EN FAIT UN
	MOVE	D3,(A0)
	ADDQ.L	#8,A0
	DBF	D7,DO_IT_AGAIN_
FINI2	RTS
****
	
ROUTY1	;D0 PLUS PETIT
	MOVE.L	D0,D2
	SUB.L	D0,D1	D1=AMPLITUDE
	DIVU	D6,D1
	SWAP	D1
	CLR	D1
	SWAP	D1
MODIF	EQU	*+2
	MOVE	#0,D7
	SUBQ	#1,D7
DO_IT_AGAIN	ADD.L	D1,D2
	MOVE.L	D2,D3
	LSR.L	#8,D3	CA EN FAIT UN
	MOVE	D3,(A0)
	ADDQ.L	#8,A0
	DBF	D7,DO_IT_AGAIN
FINI	RTS
****
			
	DATA

FORME_DEP	
 dc 85,169
 dc 101,169

 dc 101,169
 dc 99,175
 
 dc 99,175
 dc 83,176
 
 dc 83,176
 dc 85,169
 
FORME_FIN
 dc 85-3+2,168-2
 dc 101+3+2,168-2

 dc 101+3+2,168-2
 dc 99+3-3,175+20+3
 
 dc 99+3-3,175+20+3
 dc 83-3-2,176+20+4
 
 dc 83-3-2,176+20+4
 dc 85-3+2,168-2
 
 
IMG	INCBIN	SCREEN.PI1
LINE	INCBIN	LINE.BIN
	
 	BSS
 	EVEN
F_PILE	DS.L 	128	
D_PILE	DS.L 	1
PNT	DS.L	1
SCREEN1	DS.L	1
SCREEN2	DS.L	1
	DS.B	256
BUFFER	DS.B	32000*2
COORD	DS.B	8*NB_PASSES*NB_SEG
	DS.L	1
