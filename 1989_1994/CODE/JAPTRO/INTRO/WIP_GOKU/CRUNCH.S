;A0 = buffer de 3D g‚n‚r‚e
;A1 = buffer donn‚es
;A2 = buffer offset
;D7 = pointeur pour A2
;D6 = compteur pour bits ( d‚but/fin de passe )

;COMBLER AVEC DES BITS NULS LE DEPART

	OPT	O+,W-
MAIN
	CLR.L	-(SP)
	MOVE	#$20,-(SP)
	TRAP	#1
	ADDQ.L	#6,SP

	LEA	COD1,A0
	LEA	BUF1,A1
	LEA	BUF2,A2
	MOVEQ	#0,D0
	MOVEQ	#15,D7
	MOVEQ	#0,D6
ANEW
	REPT	8	donn‚es les plus r‚p‚t‚es
	MOVE.L	(A0)+,(A1)+	… copier pour chaque passe
	ENDR		dans le buf de donnees

	JSR	DEBUT	routine qui repŠre le 1er
;			offset utilis‚
	CMP.L	#BUF1,A0	Au cas o—...
	BGE	W_A_R_N_I_N_G
	
BOUCLE	MOVE	(A0)+,D0
	CMPI	#$317C,D0	MOVE.W #XX,0(A0)
	BEQ	MOVE_W
	CMPI	#$217C,D0	MOVE.L #XX,0(A0)
	BEQ	MOVE_L
	CMPI	#$2140,D0	MOVE.L D0,0(A0)
	BLT	SUITE_0
	CMPI	#$2147,D0	MOVE.L D7,0(A0)
	BLE	MOVE_W_DN
SUITE_0	CMPI	#$3140,D0	MOVE   D0,0(A0)
	BLT	SUITE_1
	CMPI	#$3147,D0	MOVE   D7,0(A0)
	BLE	MOVE_W_DN
SUITE_1
	CMPI	#$42A8,D0	CLR.L 0(A0)
	BEQ	CLR_L
	CMPI	#$4268,D0	CLR 0(A0)
	BEQ	CLR_W
	CMPI	#$4E75,D0
	BEQ	RTS_
;	CMPI	#$9999,D0
;	BEQ	FINI2
PROBLEME	MOVE	#$700,$FFFF8240.W
	BRA.S	PROBLEME
;FINI2	MOVE	#$070,$FFFF8240.W
;	BRA.S	FINI2

MOVE_W	MOVE	(A0)+,(A1)+
	ADDQ	#2,A0
	BSET	D7,(A2)
	ADDQ	#1,D6
	SUBQ	#1,D7
	BGE	BOUCLE
	MOVEQ	#15,D7
	ADDQ	#1,A2
	BRA	BOUCLE
MOVE_L	MOVE.L	(A0)+,(A1)+
	ADDQ	#2,A0
	BSET	D7,(A2)
	ADDQ	#1,D6
	SUBQ	#1,D7
	BGE	PLUS_1
	MOVEQ	#15,D7
	ADDQ	#1,A2
PLUS_1	BSET	D7,(A2)
	ADDQ	#1,D6
	SUBQ	#1,D7
	BGE	BOUCLE
	MOVEQ	#15,D7
	ADDQ	#1,A2
	BRA	BOUCLE
CLR_W	CLR	(A1)+
	ADDQ	#2,A0
	BSET	D7,(A2)
	ADDQ	#1,D6
	SUBQ	#1,D7
	BGE	BOUCLE
	MOVEQ	#15,D7
	ADDQ	#1,A2
	BRA	BOUCLE
CLR_L	CLR.L	(A1)+
	ADDQ	#2,A0
	BSET	D7,(A2)
	ADDQ	#1,D6
	SUBQ	#1,D7
	BGE	PLUS_1B
	MOVEQ	#15,D7
	ADDQ	#1,A2
PLUS_1B	BSET	D7,(A2)
	ADDQ	#1,D6
	SUBQ	#1,D7
	BGE	BOUCLE
	MOVEQ	#15,D7
	ADDQ	#1,A2
	BRA	BOUCLE
RTS_	MOVE	#4000,D5
	SUB	D6,D5
RTS2	;BSET	D7,(A2)
	SUBQ	#1,D5
	BLT	FINITO
	SUBQ	#1,D7
	BGE	RTS2
	MOVEQ	#15,D7
	ADDQ	#1,A2
	BRA.S	RTS2
FINITO	MOVEQ	#15,D7
	MOVEQ	#0,D6
	BRA	ANEW
MOVE_W_DN	MOVE	-2(A0),(A1)+
	ADDQ	#2,A0
	BSET	D7,(A2)
	ADDQ	#1,D6
	SUBQ	#1,D7
	BGE	BOUCLE
	MOVEQ	#15,D7
	ADDQ	#1,A2
	BRA	BOUCLE
;MOVE_L_DN	MOVE	-2(A0),(A1)+
;	ADDQ	#2,A0
;	BSET	D7,(A2)
;	ADDQ	#1,D6
;	SUBQ	#1,D7
;	BGE	BOUCLE
;	MOVEQ	#15,D7
;	ADDQ	#1,A2
;	BRA	BOUCLE
DEBUT	
	MOVE	(A0),D0
	CMPI	#$317C,D0
	BEQ	ROUTINE1
	CMPI	#$217C,D0
	BEQ	ROUTINE2
	CMPI	#$2140,D0
	BLT	SUITE_0B
	CMPI	#$2147,D0
	BLE	ROUTINE3
SUITE_0B	CMPI	#$3140,D0
	BLT	SUITE_1B
	CMPI	#$3147,D0
	BLE	ROUTINE3
SUITE_1B
	CMPI	#$42A8,D0
	BEQ	ROUTINE3
	CMPI	#$4268,D0
	BEQ	ROUTINE3
	CMPI	#$4E75,D0
	BEQ	ANEW2
	CMPI	#$9999,D0
	BEQ	FINI
PROB2	MOVE	#$700,$FFFF8240.W
FINI	BRA.S	FINI
ANEW2	ADDQ	#2,A0
	BRA	ANEW
ROUTINE1	MOVE	4(A0),D4
	BRA.S	CONT
ROUTINE2	MOVE	6(A0),D4
	BRA.S	CONT
ROUTINE3	MOVE	2(A0),D4
CONT	LSR	#3,D4
	SUBQ	#1,D4
	BEQ	BOUCLE
;D4 = NB DE BITS NULS A SAUTER
;	MOVE.L	D4,D3
;	LSR	#3,D4

	MOVEQ	#15,D7
YY	;BSET	D7,(A2)
	SUBQ	#1,D4
	BLT	BOUCLE
	SUBQ	#1,D7
	BGE	YY
	MOVEQ	#15,D7
	ADDQ	#1,A2
	BRA.S	YY
W_A_R_N_I_N_G	MOVE	#$007,$FFFF8240.W
	BRA.S	W_A_R_N_I_N_G
	DATA
COD1	INCBIN	REBOND.COD	37348
	DCB.L	20,$99999999
	BSS
BUF1	DS.B	100000
BUF2	DS.B	100000
