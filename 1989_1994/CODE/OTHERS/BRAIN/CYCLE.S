**************************************************************************
* 	COMPTEUR DE CYCLE D' INSTRUCIONS 68000		 *
*		par BEAST de NEW GENERATION CREW		 *
*			Version V1.0 du 16/Juin/1991	 *
*	           -$300 nb de cycle & $304 nb d' instrucion inconnu *
*	           -Doit etre executer en SUPERVISEUR		 *
**************************************************************************

***********	EXEMPLE
;
;	bsr	cycle
;	prog
;	bsr	cycle+2
;cycle	include	\cycle.s

***********	ROUTINE

	BRA.S	Cyclecount
	BRA.S	Cyclend

*********** INITIALISATION

Cyclecount	CLR.L	$300.w
	CLR.L	$304.w

	MOVE.W	SR,D0		;RECUP LE SR

	BTST	#15,D0		;DEJA EN TRACE ?
	BNE.S	End		;OUI ALORS END

	LEA	Trace(PC),A0
	MOVE.L	A0,$24.W		;MET ADD DU PRG DANS POINTEUR DU MODE TRACE

	BSET	#15,D0
	MOVE.W	D0,SR		;PASSE EN TRACE
	RTS

End	ILLEGAL

*********** FIN

Cyclend	ANDI.W	#$7FFF,SR		;COUPE LE MODE TRACE
	SUBI.L	#$54,$300.W
	RTS			;$300 NB DE CYCLE & $304 NB INSTRUCTION INCONNU

*********** RT TRACE

Trace	MOVEM.L	D0-D7/A0-A6,-(SP)
	MOVE.L	62(SP),A0		;ADD DE L'INSTRUCTION PROCHAINE
	MOVE.W	(A0),D0		;OP CODE DE LA PROCHANINE INSTRUCTION
	LEA	Dta,A1

Suite2	MOVE.W	(A1),D1
	CMP.W	#$FFFF,D1		;FIN TABLE ?
	BEQ.S	Notfound
	MOVE.W	D0,D2
	MOVE.W	2(A1),D3
	AND.W	D3,D2		;MASK
	CMP.W	D1,D2
	BEQ.S	Find
	ADD.L	#12,A1
	BRA.S	Suite2

Find	ADDQ.L	#4,A1
	MOVE.L	(A1)+,A2
	JMP	(A2)		;SAUTE A LA ROUTINE DE TRAITEMENT

Notfound	ADDI.L	#1,$304.w

Endt	MOVEM.L	(SP)+,D0-D7/A0-A6
	RTE

Simple	MOVEQ.L	#0,D0
	MOVE.W	2(A1),D0
	ADD.L	D0,$300.w
	BRA.S	Endt

Addef05	AND.W	#%111111,D0			;AVEC ADD EFFECTIVE 0-5
	MOVE.W	D0,D1
	LSR.W	#3,D1			;D1=SOUS_CHAMP
	CMPI.W	#%111,D1
	BNE.S	Suite1
	AND.W	#%111,D0
	ADD.W	D0,D1
Suite1	MOVE.L	(A1),A2
	LSL.W	D1
	MOVEQ	#0,D2
	MOVE.W	(A2,D1.W),D2
	ADD.L	D2,$300.w
	BRA.S	Endt

Movebw	MOVE.W	D0,D1
	AND.W	#%0000111111000000,D0
	LSR.W	#6,D0
	MOVE.W	D0,D2
	AND.W	#%111,D0
	CMP.W	#%111,D0
	BNE.S	Suite3
	MOVE.W	D2,D0
Suite3	MOVE.L	(A1),A0
	LEA	Addeffbw(PC),A1
	LSL.W	D0
	MOVE.W	(A0,D0.W),D0
	AND.W	#%111111,D1
	MOVE.W	D1,D2
	LSR.W	#3,D2
	CMPI.W	#%111,D2
	BNE.S	Suite4
	AND.W	#%111,D1
	ADD.W	D1,D2
Suite4	LSL.W	D2
	MOVEQ	#0,D1
	ADD.W	D0,D1
	ADD.W	(A1,D2.W),D1
	ADD.L	D1,$300.w
	BRA.S	Endt

Movel	MOVE.W	D0,D1
	AND.W	#%0000111111000000,D0
	LSR.W	#6,D0
	MOVE.W	D0,D2
	AND.W	#%111,D0
	CMP.W	#%111,D0
	BNE.S	Suite5
	MOVE.W	D2,D0
Suite5	MOVE.L	(A1),A0
	LEA	Addeffl(PC),A1
	LSL.W	D0
	MOVE.W	(A0,D0.W),D0
	AND.W	#%111111,D1
	MOVE.W	D1,D2
	LSR.W	#3,D2
	CMPI.W	#%111,D2
	BNE.S	Suite6
	AND.W	#%111,D1
	ADD.W	D1,D2
Suite6	LSL.W	D2
	MOVEQ	#0,D1
	ADD.W	D0,D1
	ADD.W	(A1,D2.W),D1
	ADD.L	D1,$300.w
	BRA	Endt

Bcc	MOVE.L	(A1),A1
	ANDI.W	#%0000111100000000,D0
	ANDI.W	#%1111000011111111,Suite7
	OR.W	D0,Suite7
	MOVE.W	60(SP),CCR
Suite7	BEQ.S	Suite8
	ADDQ.L	#2,A1
Suite8	MOVEQ	#0,D0
	MOVE.W	(A1),D0
	ADD.L	D0,$300.w
	BRA	Endt

Scc	MOVE.L	(A1),A1
	MOVE.W	D0,D1
	ANDI.W	#%0000111100000000,D1
	ANDI.W	#%1111000011111111,Suite9
	OR.W	D1,Suite9
	MOVE.W	60(SP),CCR
Suite9	BEQ.S	Suite10
	ADDA.L	#24,A1
Suite10	AND.W	#%111111,D0
	MOVE.W	D0,D1
	LSR.W	#3,D1
	CMPI.W	#%111,D1
	BNE.S	Suite11
	AND.W	#%111,D0
	ADD.W	D0,D1
Suite11	LSL.W	D1
	MOVEQ	#0,D2
	MOVE.W	(A1,D1.W),D2
	ADD.L	D2,$300.w
	BRA	Endt

Trap5	MOVE.L	(A1),A1
	MOVE.W	60(SP),CCR
	BCS.S	Suite12
	ADDQ.L	#2,A1
Suite12	MOVE.W	(A1),D0
	ADD.L	D0,$300.w
	BRA	Endt

Movemmr	MOVE.W	2(A0),D1
	MOVEQ	#0,D3
	MOVEQ	#15,D2
	MOVEQ	#5,D4
	BTST	#6,D0
	BEQ.S	Suite14
	ADDQ.L	#5,D4
Suite14	BTST	D2,D1
	BEQ.S	Suite13
	ADD.L	D4,D3
Suite13	DBRA	D2,Suite14
	ADD.L	D3,$300.w
	BRA	Addef05

Movemrm	MOVE.W	2(A0),D1
	MOVEQ	#0,D3
	MOVEQ	#15,D2
	MOVEQ	#4,D4
	BTST	#6,D0
	BEQ.S	Suite16
	MOVEQ	#8,D4
Suite16	BTST	D2,D1
	BEQ.S	Suite15
	ADD.L	D4,D3
Suite15	DBRA	D2,Suite16
	ADD.L	D3,$300.w
	BRA	Addef05

Decaope	MOVE.L	(A1),A1
	MOVEQ	#0,D1
	ADD.W	(A1),D1
	AND.W	#%0000111000000000,D0
	LSR.W	#8,D0
	TST.W	D0
	BNE.S	Suite17
	MOVEQ	#16,D0
Suite17	ADD.W	D0,D1
	ADD.L	D1,$300.w
	BRA	Endt

Decadn	MOVE.L	(A1),A1
	MOVEQ	#0,D1
	ADD.W	(A1),D1
	AND.W	#%0000111000000000,D0
	LSR.W	#8,D0
	LSR.W	D0
	AND.W	#%1111111111111000,Suite18
	OR.W	D0,Suite18
	MOVE.L	D1,Sauve
	MOVEM.L	(SP),D0-D7/A0-A6
Suite18	MOVE.W	D0,D0
	AND.W	#%0000000000111111,D0
	TST.W	D0
	BNE.S	Suite19
	MOVEQ	#64,D0
Suite19	LSL.W	D0
	MOVE.L	Sauve,D1
	ADD.W	D0,D1
	ADD.L	D1,$300.w
	BRA	Endt

Dbcc	MOVE.L	(A1),A1
	MOVE.L	A1,Sauve
	MOVE.W	D0,D1
	AND.W	#%0000000000000111,D0
	AND.W	#%1111111111111000,Suite20
	OR.W	D0,Suite20
	AND.W	#%0000111100000000,D1
	AND.W	#%1111000011111111,Suite21
	OR.W	D1,Suite21
	MOVEM.L	(SP),D0-D7/A0-A6
	MOVE.L	Sauve,A1
Suite20	TST.W	D0
	BEQ.S	Suite22
	ADDQ.L	#2,A1
	MOVE.W	60(SP),CCR
Suite21	SLT	D1
	TST.W	D1
	BNE.S	Suite22
	ADDQ.L	#2,A1
Suite22	MOVEQ	#0,D0
	ADD.W	(A1),D0
	ADD.L	D0,$300.w
	BRA	Endt

*********** Data

Dta	DC.W	%0001000000000000,%1101000000000000	;MOVE.W & MOVE.B
	DC.L	Movebw,Movebwtab
	DC.W	%0010000000000000,%1111000000000000	;MOVE.L
	DC.L	Movel,Moveltab
	DC.W	%0110000000000000,$FF00		;BRA
	DC.L	Simple,10
	DC.W	%0110000100000000,$FF00		;BSR (Avant Bcc)
	DC.L	Simple,20
	DC.W	%0110000000000000,%1111000011111111 ;Bcc.S
	DC.L	Bcc,Bccltab
	DC.W	%0110000000000000,%1111000000000000	;Bcc.L
	DC.L	Bcc,Bccstab
	DC.W	%0101000011001000,%1111000011111000	;DBcc (Avant Scc)
	DC.L	Dbcc,Dbcctab
	DC.W	%0100111001110001,$FFFF		;NOP
	DC.L	Simple,4
	DC.W	%0100111001110010,$FFFF		;STOP
	DC.L	Simple,4
	DC.W	%0100111001110011,$FFFF		;RTE
	DC.L	Simple,20
	DC.W	%0100111001110101,$FFFF		;RTS
	DC.L	Simple,16
	DC.W	%0100111011000000,%1111111111000000	;JMP
	DC.L	Addef05,Jmptab
	DC.W	%0100111010000000,%1111111111000000	;JSR
	DC.L	Addef05,Jsrtab
	DC.W	%0100100001000000,%1111111111000000	;PEA
	DC.L	Addef05,Peatab
	DC.W	%0100000111000000,%1111000111000000	;LEA
	DC.L	Addef05,Leatab
	DC.W	%0100101011000000,%1111111111000000	;TAS
	DC.L	Addef05,Tastab
	DC.W	%0100100000000000,%1111111111000000	;NBCD
	DC.L	Addef05,Movedsr
	DC.W	%0100001000000000,%1111111110000000	;CLR.W & CLR.B
	DC.L	Addef05,Clrbw
	DC.W	%0100001010000000,%1111111111000000	;CLR.L
	DC.L	Addef05,Clrl
	DC.W	%0100010000000000,%1111111110000000	;NEG.W & NEG.B
	DC.L	Addef05,Clrbw
	DC.W	%0100010010000000,%1111111111000000	;NEG.L
	DC.L	Addef05,Clrl
	DC.W	%0100000000000000,%1111111110000000	;NEGX.W & NEGX.B
	DC.L	Addef05,Clrbw
	DC.W	%0100000010000000,%1111111111000000	;NEGX.L
	DC.L	Addef05,Clrl
	DC.W	%0100011000000000,%1111111110000000	;NOT.W & NOT.B
	DC.L	Addef05,Clrbw
	DC.W	%0100011010000000,%1111111111000000	;NOT.L
	DC.L	Addef05,Clrl
	DC.W	%0100101000000000,%1111111100000000	;TST
	DC.L	Addef05,Tsttab
	DC.W	%0000001000000000,%1111111110000000	;ANDI.W & ANDI.B
	DC.L	Addef05,Andibw
	DC.W	%0000001010000000,%1111111111000000	;ANDI.L
	DC.L	Addef05,Andil
	DC.W	%0000000000000000,%1111111110000000	;ORI.W & ORI.B
	DC.L	Addef05,Andibw
	DC.W	%0000000010000000,%1111111111000000	;ORI.L
	DC.L	Addef05,Andil
	DC.W	%0000101000000000,%1111111110000000	;EORI.W & EORI.B
	DC.L	Addef05,Andibw
	DC.W	%0000101010000000,%1111111111000000	;EORI.L
	DC.L	Addef05,Andil
	DC.W	%0000010000000000,%1111110110000000	;ADDI.W & ADDI.B & SUBI.W & SUBI.B
	DC.L	Addef05,Andibw
	DC.W	%0000010010000000,%1111110111000000	;ADDI.L & SUBI.L
	DC.L	Addef05,Andil
	DC.W	%0101000000000000,%1111000010000000	;ADDQ.W & ADDQ.B & SUBQ.W & SUB.B
	DC.L	Addef05,Clrbw
	DC.W	%0101000010000000,%1111000011000000	;ADDQ.L & SUBQ.L
	DC.L	Addef05,Addql
	DC.W	%0000110010000000,%1111111111000000	;CMPI.L
	DC.L	Addef05,Cmpil
	DC.W	%0000110000000000,%1111111110000000	;CMPI.W & CMP.B
	DC.L	Addef05,Cmpibw
	DC.W	%1110000011000000,%1111100011000000	;ASR & ASL & LSR & LSL & ROXR & ROXL & ROR & ROL (en memoire)
	DC.L	Addef05,Movedsr
	DC.W	%0000000101000000,%1111000101000000	;BCHG & BSET(dynamique)
	DC.L	Addef05,Bchgd
	DC.W	%0000100001000000,%1111111101000000	;BCHG & BSET (statique)
	DC.L	Addef05,Bchgs
	DC.W	%0000000110000000,%1111000111000000	;BCLR (dynamique)
	DC.L	Addef05,Bclrd
	DC.W	%0000100110000000,%1111111111000000	;BCLR (statique)
	DC.L	Addef05,Bclrs
	DC.W	%0000000100000000,%1111000111000000	;BTST (dynamique)
	DC.L	Addef05,Btstd
	DC.W	%0000100100000000,%1111111111000000	;BTST (statique)
	DC.L	Addef05,Btsts
	DC.W	%0000000100001000,%1111000111111000	;MOVEP.W add,Dn
	DC.L	Simple,16
	DC.W	%0000000101001000,%1111000111111000	;MOVEP.L add,Dn
	DC.L	Simple,24
	DC.W	%0000000110001000,%1111000111111000	;MOVEP.W Dn,add
	DC.L	Simple,18
	DC.W	%0000000111001000,%1111000111111000	;MOVEP.L Dn,add
	DC.L	Simple,28
	DC.W	%1001000100000000,%1011000110111000	;ADDX.B & ADDX.W & SUBX.W & SUBX.B (donn‚e)
	DC.L	Simple,4
	DC.W	%1001000110000000,%1011000111111000	;ADDX.L & SUBX.L (donn‚e)
	DC.L	Simple,8
	DC.W	%1001000100001000,%1011000110111000	;ADDX.B & ADDX.W & SUBX.W & SUBX.B (add)
	DC.L	Simple,19
	DC.W	%1001000110001000,%1011000111111000	;ADDX.L & SUBX.L (add)
	DC.L	Simple,32
	DC.W	%1011000100001000,%1111000110111000	;CMPM.W & CMPM.B
	DC.L	Simple,12
	DC.W	%1011000110001000,%1111000111111000	;CMPM.L
	DC.L	Simple,20
	DC.W	%1000000100000000,%1011000111111000	;ABCD & SBCD (donn‚e)
	DC.L	Simple,6
	DC.W	%1000000100001000,%1011000111111000	;ABCD & SBCD (add)
	DC.L	Simple,19
	DC.W	%1001000000000000,%1011000110000000	;ADD.W & ADD.B & SUB.W & SUB.B (Dn+ae=Dn)
	DC.L	Addef05,Tab4
	DC.W	%1001000100000000,%1011000110000000	;ADD.W & ADD.B & SUB.W & SUB.B (Dn+ae=ae)
	DC.L	Addef05,Tab9
	DC.W	%1001000010000000,%1011000111000000	;ADD.L & SUB.L (Dn+ae=Dn)
	DC.L	Addef05,Tab6l
	DC.W	%1001000110000000,%1011000111000000	;ADD.L & SUB.L (Dn+ae=ae)
	DC.L	Addef05,Tab14l
	DC.W	%1001000011000000,%1011000111000000	;ADDA.W & SUBA.W 
	DC.L	Addef05,Tab8
	DC.W	%1001000111000000,%1011000111000000	;ADDA.L & SUBA.L 
	DC.L	Addef05,Tab6l
	DC.W	%1000000000000000,%1011000110000000	;AND.W & AND.B & OR.W & OR.B (Dn+ae=Dn)
	DC.L	Addef05,Tab4
	DC.W	%1000000100000000,%1011000110000000	;AND.W & AND.B & OR.W & OR.B (Dn+ae=ae)
	DC.L	Addef05,Tab9
	DC.W	%1000000010000000,%1011000111000000	;AND.L & OR.L (Dn+ae=Dn)
	DC.L	Addef05,Tab6l
	DC.W	%1000000110000000,%1011000111000000	;AND.L & OR.L (Dn+ae=ae)
	DC.L	Addef05,Tab14l
	DC.W	%1011000000000000,%1111000110000000	;CMP.W & CMP.B (Dn,ae)
	DC.L	Addef05,Tab4
	DC.W	%1011000010000000,%1111000111000000	;CMP.L (Dn,ae)
	DC.L	Addef05,Tab6l
	DC.W	%1011000011000000,%1111000111000000	;CMPA.W & CMPA.B
	DC.L	Addef05,Tab6
	DC.W	%1011000111000000,%1111000111000000	;CMPA.L
	DC.L	Addef05,Tab6l
	DC.W	%1011000100000000,%1111000110000000	;EOR.W & EOR.B
	DC.L	Addef05,Clrbw
	DC.W	%1011000110000000,%1111000111000000	;EOR.L
	DC.L	Addef05,Addql
	DC.W	%0101000011000000,%1111000011000000	;Scc
	DC.L	Scc,Scctab
	DC.W	%0100111001110110,$FFFF		;TRAPV
	DC.L	Trap5,Trap5tab
	DC.W	%0100100010000000,%1111111110000000	;MOVEM.W & MOVEM.L (reg>mem)
	DC.L	Movemmr,Movemtab1
	DC.W	%0100110010000000,%1111111110000000	;MOVEM.W & MOVEM.L (reg<mem)
	DC.L	Movemrm,Movemtab2
	DC.W	%1110000000000000,%1111000010100000	;ASL & ASR & LSR & LSL & ROXR & ROXL & ROR & ROL (.B & .W #val,Dn)
	DC.L	Decaope,Decatabwb
	DC.W	%1110000010000000,%1111000011100000	;ASL & ASR & LSR & LSL & ROXR & ROXL & ROR & ROL (.L #val,Dn)
	DC.L	Decaope,Decatabl
	DC.W	%1110000000100000,%1111000010100000	;ASL & ASR & LSR & LSL & ROXR & ROXL & ROR & ROL (.B & .W Dn,Dn)
	DC.L	Decadn,Decatabwb
	DC.W	%1110000010100000,%1111000011100000	;ASL & ASR & LSR & LSL & ROXR & ROXL & ROR & ROL (.L Dn,Dn)
	DC.L	Decadn,Decatabl
	DC.W	%0100111001110000,$FFFF		;RESET
	DC.L	Simple,132
	DC.W	%0100111001110111,$FFFF		;RTR
	DC.L	Simple,20
	DC.W	%1100000011000000,%1111000011000000	;MULU & MULS
	DC.L	Addef05,Multab
	DC.W	%1000000011000000,%1111000111000000	;DIVU
	DC.L	Addef05,Divutab
	DC.W	%1000000111000000,%1111000111000000	;DIVS
	DC.L	Addef05,Divstab
	DC.W	%0111000000000000,%1111000100000000	;MOVEQ
	DC.L	Simple,4
	DC.W	%1100000100000000,%1111000100000000	;EXG ????
	DC.L	Simple,6
	DC.W	%0100100010000000,%1111111110111000	;EXT
	DC.L	Simple,4
	DC.W	%0100111001000000,%1111111111110000	;TRAP
	DC.L	Simple,7
	DC.W	%0100111001010000,%1111111111111000	;LINK
	DC.L	Simple,18
	DC.W	%0100111001100000,%1111111111110000	;MOVE DE ou A USP
	DC.L	Simple,4
	DC.W	%0100100001000000,%1111111111111000	;SWAP
	DC.L	Simple,4
	DC.W	%0100111001010000,%1111111111111000	;UNLK
	DC.L	Simple,12
	DC.W	%0100010011000000,%1111110111000000	;MOVE vers SR & MOVE vers SR
	DC.L	Addef05,Movevsr
	DC.W	%0100000011000000,%1111111111000000	;MOVE de SR
	DC.L	Addef05,Movevsr
	DC.W	$FFFF

Movedsr	DC.W	6,6,13,13,15,17,19,17,21,17,19,13
Movevsr	DC.W	12,12,16,16,18,20,22,20,24,20,22,16
Jmptab	DC.W	8,0,0,10,14,10,12,10,14
Jsrtab	DC.W	18,0,0,20,24,20,22,20,24
Leatab	DC.W	4,0,0,8,12,8,12,8,12
Peatab	DC.W	14,0,0,18,22,18,22,18,22
Tastab	DC.W	4,4,15,15,17,19,21,19,23,19,21,15
Multab	DC.W	70,70,74,74,76,78,80,78,82,78,80,74
Divutab	DC.W	140,140,144,144,146,148,150,148,152,148,150,144
Divstab	DC.W	158,158,162,162,164,166,168,166,170,166,168,162
Clrbw	DC.W	4,4,13,13,15,17,19,17,21,17,19,13
Clrl	DC.W	6,6,22,22,24,26,28,26,30,26,28,22
Tsttab	DC.W	4,4,8,8,10,12,14,12,16,12,14,8
Andibw	DC.W	8,0,17,17,19,21,23,21,25,0,0,20
Andil	DC.W	16,16,30,30,32,34,36,34,38,34,36,30
Addql	DC.W	8,8,22,22,24,26,28,26,30,28,22
Cmpibw	DC.W	8,8,12,12,14,16,18,16,20,16,18,12
Cmpil	DC.W	14,14,20,20,22,24,26,24,28,24,26,20
Bchgd	DC.W	8,8,13,13,15,17,19,17,21,17,19,13
Bchgs	DC.W	12,12,17,17,19,21,23,21,25,21,23,17
Bclrd	DC.W	8,8,13,13,15,17,19,17,21,17,19,13
Bclrs	DC.W	14,14,17,17,19,21,23,21,25,21,23,17
Btstd	DC.W	6,6,8,8,10,12,14,12,16,12,14,8
Btsts	DC.W	10,10,12,12,14,16,18,16,20,16,18,12
Tab4	DC.W	4,4,8,8,10,12,14,12,16,12,14,8
Tab6	DC.W	6,6,10,10,12,14,16,14,18,14,16,10
Tab6l	DC.W	6,6,14,14,16,18,20,18,22,18,20,14
Tab8	DC.W	8,8,12,12,14,16,18,16,20,16,18,12
Tab9	DC.W	9,9,13,13,15,17,19,17,21,17,19,13
Tab14l	DC.W	14,14,22,22,24,26,28,26,30,26,28,22
Movebwtab	DC.W	4,4,9,9,9,13,15,13,17
Addeffbw	DC.W	0,0,4,4,6,8,10,8,12,8,10,4
Moveltab	DC.W	4,4,14,14,16,18,20,18,22
Addeffl	DC.W	0,0,8,8,10,12,14,12,16,12,14,8
Bccstab	DC.W	10,8
Bccltab	DC.W	10,12
Scctab	DC.W	6,6,13,13,15,17,19,17,21,17,19,13
	DC.W	4,4,13,13,15,17,19,17,21,17,19,13
Trap5tab	DC.W	37,4
Movemtab1	DC.W	0,0,12,12,0,16,18,16,20,16,18
Movemtab2	DC.W	0,0,8,0,8,12,14,12,16
Decatabwb	DC.W	6
Decatabl	DC.W	8
Dbcctab	DC.W	10,12,14

Sauve	DC.L	0
