NEXT_IMG	
	MOVE.L	(A4),A0
	LEA	2(A0),A0
	BSR	CALC_FADE

	BSR	FADE_UP

	BSR	FADE_DOWN
	BRA.S	NEXT_IMG

FADE_UP	MOVE.L	#ADR_FADE,PT_FADE
	CLR.W	NB_VBL
.CONT_FADE	BSR	VSYNC
	MOVE.L	PT_FADE,A0
	MOVEM.L	(A0)+,D0-D7
	MOVEM.L	D0-D7,$FFFF8240.W
	CMPA.L	#ADR_FADE+16*32,A0
	BEQ.S	.FINI
	MOVE.L	A0,PT_FADE
	BRA.S	.CONT_FADE
.FINI	RTS

FADE_DOWN	MOVE.L	#ADR_FADE+16*32,PT_FADE
	CLR.W	NB_VBL
.CONT_FADE	BSR	VSYNC
	MOVE.L	PT_FADE,A0
	MOVEM.L	(A0)+,D0-D7
	MOVEM.L	D0-D7,$FFFF8240.W
	CMPA.L	#ADR_FADE+32*32,A0
	BEQ.S	.FINI
	MOVE.L	A0,PT_FADE
	BRA.S	.CONT_FADE
.FINI	RTS

VSYNC	CMPI.W	#2,NB_VBL
	BLT.S	VSYNC
	CLR.W	NB_VBL
	RTS	
NB_VBL	DC	0
	;A0=ADRESSE DE LA PALETTE
CALC_FADE	MOVEM.L	(A0),D0-D7
	LEA	ADR_FADE+16*32,A0
	MOVEM.L	D0-D7,(A0)
	LEA	OFFSETS(PC),A5
	LEA	COLORS-1(PC),A4
	LEA	32(A0),A1
	MOVE.W	#16*16-1,D7 ;POUR LES 16 COULEURS ET 8 FADES
NEXT_COLOR	MOVEQ	#0,D3
	MOVE.W	(A0)+,D0
	MOVE.W	D0,D1	;COMPOSANTE BLEUE
	ANDI.W	#$F,D1
	MOVEQ	#0,D2
	MOVE.B	(A5,D1.W),D2	;OFFSET
	MOVE.B	(A4,D2.W),D3
	MOVE.W	D0,D1	;COMPOSANTE VERTE
	ANDI.W	#$F0,D1
	LSR.W	#4,D1
	MOVEQ	#0,D2
	MOVE.B	(A5,D1.W),D2
	MOVE.B	(A4,D2.W),D2
	LSL.W	#4,D2
	OR.W	D2,D3
	MOVE.W	D0,D1	;COMPOSANTE ROUGE
	ANDI.W	#$F00,D1
	LSR.W	#4,D1
	LSR.W	#4,D1
	MOVEQ	#0,D2
	MOVE.B	(A5,D1.W),D2
	MOVE.B	(A4,D2.W),D2
	LSL.W	#4,D2
	LSL.W	#4,D2
	OR.W	D2,D3
	MOVE.W	D3,(A1)+
	DBRA	D7,NEXT_COLOR
	LEA	ADR_FADE+32*16,A0
	MOVE.L	A0,A1
	REPT	16
	MOVEM.L	(A0)+,D0-D7
	MOVEM.L	D0-D7,-(A1)
	ENDR
	RTS

OFFSETS	DC.B	0,2,4,6,8,10,12,14,1,3,5,7,9,11,13,15

	DCB.W	8,0
COLORS	DC.B	0,8,1,9,2,$A,3,$B,4,$C,5,$D,6,$E,7,$F

PT_FADE	DS.L	1
ADR_FADE	DS.W	16*32