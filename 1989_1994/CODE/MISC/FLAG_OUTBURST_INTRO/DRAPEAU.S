	CLR.L	-(SP)
	MOVE.W	#$20,-(SP)
	TRAP	#1
	ADDQ.W	#6,SP

	CLR.W	-(SP)
	PEA	-1.W
	PEA	-1.W
	MOVE.W	#5,-(SP)
	TRAP	#14
	LEA	12(SP),SP

	BSR	PREP_ECR
	BSR	PREP_DRAPEAU

;	JSR	ZIK

	MOVE.W	#$2700,SR
	MOVE.L	#VBLR,$70.W
	CLR.B	$FFFFFA07.W
	CLR.B	$FFFFFA09.W
	MOVE.W	#$2300,SR

LOOP	JMP	LOOP

VBLR	CMPI.B	#$F,$FFFFFC02.W
	BNE.S	TAB
	ST	$FFFF8240.W
TAB	MOVE.W	#$7,$FFFF8242.W
	MOVE.W	#$777,$FFFF8244.W
	MOVE.W	#$700,$FFFF8248.W
	BSR	AFF_DRAPEAU
	SF	$FFFF8240.W
;	JSR	ZIK+34
	RTE

AFF_DRAPEAU	BSR	EFF_PTS
	MOVE.L	PT_INC_X,A0
	MOVE.L	PT_INC_Y,A1
	LEA	CORES_X,A2
	LEA	CORES_Y,A3
	MOVE.L	SCREEN2,A4
	MOVE.L	ADR_EFF,A6
	LEA	BUF_COD_DRAPEAU,A5
	JSR	(A5)
	MOVE.L	PT_INC_X,A0
	ADDQ.W	#2,A0
	CMPA.L	#FIN_INC_X,A0
	BNE.S	.FUCK_1
	LEA	INC_X,A0
.FUCK_1	MOVE.L	A0,PT_INC_X
	MOVE.L	PT_INC_Y,A0
	ADDQ.W	#2,A0
	CMPA.L	#FIN_INC_Y,A0
	BNE.S	.FUCK_2
	LEA	INC_Y,A0
.FUCK_2	MOVE.L	A0,PT_INC_Y

	LEA	ADR_EFF,A0
	MOVE.L	(A0)+,D0
	MOVE.L	(A0),-(A0)
	MOVE.L	D0,4(A0)
	BSR	SWAPEC
	RTS

EFF_PTS	MOVE.L	ADR_EFF,A0
	MOVE.L	SCREEN2,A1
	MOVEQ	#0,D0
	MOVE.W	NB_PTS,D7
.REPEAT	MOVE.W	(A0)+,D1
	MOVE.W	D0,(A1,D1.W)
	DBRA	D7,.REPEAT
	RTS

PREP_DRAPEAU	LEA	INC_X(PC),A0
	LEA	FIN_INC_X(PC),A1
	BSR	RECOPY
	LEA	INC_Y(PC),A0
	LEA	FIN_INC_Y(PC),A1
	BSR	RECOPY

	LEA	COOR_POINT(PC),A0
	LEA	BUF_COD_DRAPEAU,A1
	MOVEQ	#0,D3	;NB DE POINTS GENERAL
.NEXT_DIAG	CMPI.L	#"CACA",(A0)
	BEQ.S	.FINI_COD
	MOVE.W	(A0)+,D7	;NB DE POINTS-1 PAR DIAGONALE
	MOVE.L	#$34183619,(A1)+
.NEXT_POINT	MOVE.W	(A0)+,D0	;X
	MOVE.W	(A0)+,D1	;Y
	MOVE.W	(A0)+,CHG_1
	ADDQ.W	#1,D3
	CMPI.W	#127,D0
	BGT.S	.PAS_MOVEQ_X
	MOVE.W	#$7000,D2	;CODE DU MOVEQ #0,D0
	OR.W	D0,D2	;ON OR LA DONNêE <127
	MOVE.W	D2,(A1)+
	BRA.S	.X_DONE
.PAS_MOVEQ_X	MOVE.W	#$303C,(A1)+
	MOVE.W	D0,(A1)+
.X_DONE	CMPI.W	#127,D1
	BGT.S	.PAS_MOVEQ_Y
	MOVE.W	#$7200,D2	;CODE DU MOVEQ #0,D1
	OR.W	D1,D2	;ON OR LA DONNêE <127
	MOVE.W	D2,(A1)+
	BRA.S	.Y_DONE
.PAS_MOVEQ_Y	MOVE.W	#$323C,(A1)+
	MOVE.W	D1,(A1)+
.Y_DONE
CHG_1 = *+2
	MOVE.W	#$1234,D5
	CMPI.W	#1,D5
	BEQ.S	.GO_1
	CMPI.W	#2,D5
	BEQ.S	.GO_2
.GO_3	LEA	SEQUENC3COD(PC),A2
	MOVE.W	#LONG3COD-1,D5
	BRA.S	.REPRISE
.GO_2	LEA	SEQUENC2COD(PC),A2
	MOVE.W	#LONG2COD-1,D5
	BRA.S	.REPRISE
.GO_1	LEA	SEQUENC_COD(PC),A2
	MOVE.W	#LONG_COD-1,D5
.REPRISE	MOVE.B	(A2)+,(A1)+
	DBRA	D5,.REPRISE
	DBRA	D7,.NEXT_POINT
	BRA.S	.NEXT_DIAG

.FINI_COD	MOVE.W	#$4E75,(A1)
	SUBQ.W	#1,D3
	MOVE.W	D3,NB_PTS
	MOVE.L	#INC_X,PT_INC_X
	MOVE.L	#INC_Y,PT_INC_Y

	LEA	BUF_EFF,A0
	LEA	ADR_EFF,A1
	MOVE.L	A0,(A1)+
	LEA	2000(A0),A0
	MOVE.L	A0,(A1)+
	RTS

RECOPY	MOVE.L	A1,A2
.CONT	CMPA.L	A0,A2
	BEQ.S	.SORT
	MOVE.W	(A0)+,(A1)+
	BRA.S	.CONT
.SORT	RTS

SWAPEC	MOVE.L	SCREEN1,D0
	MOVE.L	SCREEN2,SCREEN1
	MOVE.L	D0,SCREEN2
	MOVE.B	SCREEN1+1,$FFFF8201.W
	MOVE.B	SCREEN1+2,$FFFF8203.W
	RTS

PREP_ECR	MOVE.L	#BUFFER,D0
	CLR.B	D0
	MOVE.L	D0,SCREEN1
	ADDI.L	#32000,D0
	MOVE.L	D0,SCREEN2
	MOVE.B	SCREEN1+1,$FFFF8201.W
	MOVE.B	SCREEN1+2,$FFFF8203.W
	RTS

SEQUENC_COD	ADD.W	D2,D0
	ADD.W	D3,D1
	ADD.W	D0,D0	;X*4
	ADD.W	D0,D0
	ADD.W	D1,D1	;Y*2
	MOVE.W	(A3,D1.W),D1	;Y*160
	ADD.W	2(A2,D0.W),D1
	MOVE.W	(A2,D0.W),D0
	OR.W	D0,(A4,D1.W)
	MOVE.W	D1,(A6)+
FIN_CODE
LONG_COD = *-SEQUENC_COD

SEQUENC2COD	ADD.W	D2,D0
	ADD.W	D3,D1
	ADD.W	D0,D0	;X*4
	ADD.W	D0,D0
	ADD.W	D1,D1	;Y*2
	MOVE.W	(A3,D1.W),D1	;Y*160
	ADD.W	2(A2,D0.W),D1
	MOVE.W	(A2,D0.W),D0
	ADDQ.W	#2,D1
	OR.W	D0,(A4,D1.W)
	MOVE.W	D1,(A6)+
FIN2CODE
LONG2COD = *-SEQUENC2COD

SEQUENC3COD	ADD.W	D2,D0
	ADD.W	D3,D1
	ADD.W	D0,D0	;X*4
	ADD.W	D0,D0
	ADD.W	D1,D1	;Y*2
	MOVE.W	(A3,D1.W),D1	;Y*160
	ADD.W	2(A2,D0.W),D1
	MOVE.W	(A2,D0.W),D0
	ADDQ.W	#4,D1
	OR.W	D0,(A4,D1.W)
	MOVE.W	D1,(A6)+
FIN3CODE
LONG3COD = *-SEQUENC3COD

	DCB.W	1000,0
N	SET	0
CORES_X	REPT	20
	DC.W	32768,N,16384,N,8192,N,4096,N,2048,N,1024,N,512,N,256,N,128,N,64,N,32,N,16,N,8,N,4,N,2,N,1,N
N	SET	N+8
	ENDR
	DCB.W	1000,0

	DCB.W	300,0
N	SET	0
CORES_Y	REPT	200
	DC.W	N*160
N	SET	N+1
	ENDR
	DCB.W	300,0

COOR_POINT	INCBIN	DRAPEAU.COR
	DC.L	"CACA"

INC_X	INCBIN	INC_X.DRA
FIN_INC_X	DS.B	FIN_INC_X-INC_X
	DC.W	$1234

INC_Y	INCBIN	INC_Y.DRA
FIN_INC_Y	DS.B	FIN_INC_Y-INC_Y
	DC.W	$1234

;ZIK	INCBIN	B:NTMNEXT.MUS

	SECTION	BSS
NB_PTS	DS.W	1
PT_INC_X	DS.L	1
PT_INC_Y	DS.L	1
SCREEN1	DS.L	1
SCREEN2	DS.L	1
ADR_EFF	DS.L	2
BUF_EFF	DS.W	1000*2
BUF_COD_DRAPEAU	DS.B	30000
	DS.B	256
BUFFER	DS.L	16000